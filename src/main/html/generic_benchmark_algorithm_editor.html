<!DOCTYPE html>
<html lang="en">
<!--
    File: generic_benchmark_algorithm_editor.html
    Purpose: Form for editing and managing generic benchmark algorithms. 
    The form allows users to define algorithm properties, test references, and evaluation conditions.
    Use can export the configuration as Excel or CSV files, then import the CVS into a Google Sheet for use 
    with the FAIR Champion Benchmark Quality Assessment tool.
    The Google Sheet must be editable by anonymous users.

    REFACTORED: Reduced code duplication by extracting common functions and patterns

    TODO: Review the use of the 'xxxCount--' code in the removeElement function.
    This code decrements the count of test references and conditions when an item is removed.
    It works as expected if the highest ID is removed, but may cause issues with duplicate IDs
    if a lower ID is removed first.
    Consider removing this code to simplify the logic and avoid potential issues with duplicate IDs.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generic Benchmark Algorithm Editor</title>

    <!- Enable CORS globally for any host ->
    <meta http-equiv="Access-Control-Allow-Origin" content="*">

    <!-- Load PapaParse from CDNJS -->
    <script 
        src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
        integrity="sha512-8d1e5b2c4f3c6f0a7b9e5c8d3f4b1a2f6c5e5b2c4f3c6f0a7b9e5c8d3f4b1a2f6c5e5b2c4f3c6f0a7b9e5c8d3f4b1a2f6c5e5b2c4f3c6f0a7b9e5c8d3f4b1a2f6c5e5b2c4f3c6f0a7b9e5c8d3f4b1a2"
    ></script>
    
    <!-- Load SheetJS (XLSX) from CDNJS -->
    <script 
        src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
        integrity="sha512-8d1e5b2c4f3c6f0a7b9e5c8d3f4b1a2f6c5e5b2c4f3c6f0a7b9e5c8d3f4b1a2f6c5e5b2c4f3c6f0a7b9e5c8d3f4b1a2f6c5e5b2c4f3c6f0a7b9e5c8d3f4b1a2f6c5e5b2c4f3c6f0a7b9e5c8d3f4b1a2"
        ></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans|Roboto:300,400,500,700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #202124;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #c5f442 0%, #47b73a 100%);
            color: white;
            padding: 32px 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.03) 2px,
                rgba(255,255,255,0.03) 4px
            );
            animation: shimmer 20s linear infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header h1 {
            font-size: 28px;
            font-weight: 300;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .form-content {
            padding: 32px 24px;
        }

        .section {
            margin-bottom: 40px;
            border: 1px solid #e8eaed;
            border-radius: 12px;
            overflow: hidden;
            transition: box-shadow 0.3s ease;
        }

        .section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f0fe 100%);
            padding: 20px 24px;
            border-bottom: 1px solid #e8eaed;
            font-weight: 500;
            font-size: 18px;
            color: #1f1f1f;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-header .icon {
            font-size: 24px;
        }

        .section-content {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #202124;
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="number"],
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e8eaed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #fafafa;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4285f4;
            background: white;
            box-shadow: 0 0 0 4px rgba(66, 133, 244, 0.1);
            transform: translateY(-1px);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .item {
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            border: 2px solid #e8eaed;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .test-reference-item:hover {
            border-color: #4285f4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.1);
        }

        .condition-item:hover {
            border-color: #34a853;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .item-header h4 {
            color: #1f1f1f;
            font-size: 16px;
            font-weight: 500;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .row-three {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .btn {
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
            color: white;
            padding: 14px 28px;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(26, 115, 232, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #5f6368;
            border: 2px solid #e8eaed;
            padding: 12px 24px;
            margin-right: 12px;
        }

        .btn-secondary:hover {
            border-color: #4285f4;
            color: #4285f4;
            transform: translateY(-1px);
        }

        .add-btn {
            background: linear-gradient(135deg, #34a853 0%, #2d7d32 100%);
            color: white;
            padding: 10px 20px;
            font-size: 13px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(52, 168, 83, 0.3);
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.4);
        }

        .remove-btn {
            background: linear-gradient(135deg, #ea4335 0%, #d33b2c 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
        }

        .remove-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(234, 67, 53, 0.4);
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 40px;
            padding-top: 32px;
            border-top: 2px solid #f1f3f4;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #90caf9;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 600;
            color: #1565c0;
        }

        .stat-label {
            font-size: 12px;
            color: #1976d2;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar {
            height: 4px;
            background: #e8eaed;
            border-radius: 2px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4285f4, #34a853);
            transition: width 0.5s ease;
        }

        .help-icon {
            cursor: help;
            background: none;
            border: none;
            padding: 0;
            font: inherit;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .row, .row-three {
                grid-template-columns: 1fr;
            }
            
            .form-content {
                padding: 20px 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Generic Benchmark Algorithm Editor</h1>
            <p>Use this form to generate a CSV file that can be imported into a Benchmark Configuration Google Sheet for use with the 
      <a href="https://tools.ostrails.eu/champion/assess/algorithm/new" target="_blank" rel="noopener">FAIR Champion Benchmark Quality Assessment tool</a>
    </p>
        </div>
        <div class="form-content">
            <!-- Statistics Section -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="testCount">2</div>
                    <div class="stat-label">Test References</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="conditionCount">2</div>
                    <div class="stat-label">Conditions</div>
                </div>
            </div>

            <form id="algorithmForm">
                <!-- Property Section -->
                <div class="section fade-in">
                    <div class="section-header">
                        <span class="icon">üìã</span>
                        <span>DCAT Property</span>
                    </div>
                    <div class="section-content">
                        <!-- ID unchanged -->
                        <div class="form-group">
                            <label for="algorithmName">Title</label>
                            <input type="text" id="algorithmName" value="Generic benchmark algorithm" required>
                        </div>
                        
                        <!-- ID new version -->
                        <div class="form-group">
                            <label for="algorithmVersion">Version</label>
                            <input type="text" id="algorithmVersion" value="1.0" required>
                        </div>

                        <!-- ID new description -->
                        <div class="form-group">
                            <label for="algorithmDescription">Description</label>
                            <input type="text" id="algorithmDescription" value="Used in conjunction with FAIR Champion test runner to calculate FAIR scores." required>
                        </div>

                        <!-- ID new keyword -->
                        <div class="form-group">
                            <label for="algorithmKeywords">Keywords</label>
                            <input type="text" id="algorithmKeywords" value="FAIR, benchmark, algorithm" required>
                        </div>

                        <!-- ID new abbreviation -->
                        <div class="form-group">
                            <label for="algorithmAbbreviation">Abbreviation</label>
                            <input type="text" id="algorithmAbbreviation" value="FAIRalgorithm" required>
                        </div>

                        <!-- ID new repository -->
                        <div class="form-group">
                            <label for="algorithmRepository">Repository</label>
                            <input type="url" id="algorithmRepository" value="https://docs.google.com/spreadsheets/d/16s2klErdtZck2b6i2Zp_PjrgpBBnnrBKaAvTwrnMB4w/edit?gid=0#gid=0" required>
                        </div>

                        <!-- ID new type -->
                        <div class="form-group">
                            <label for="algorithmType">Type</label>
                            <input type="url" id="algorithmType" value="http://ontology.ethereal.cz/irao/Benchmark" required>
                        </div>

                        <!-- ID new license -->
                        <div class="form-group">
                            <label for="algorithmLicence">Licence</label>
                            <input type="url" id="algorithmLicence" value="http://creativecommons.org/publicdomain/zero/1.0/" required>
                        </div>

                        <!-- ID renamed from relevantCommunity to applicationArea DONE -->
                        <div class="form-group">
                            <label for="algorithmApplicationArea">Application Area</label>
                            <input type="url" id="algorithmApplicationArea" value="http://www.fairsharing.org/ontology/subject/SRAO_0000401" required>
                        </div>

                        <!-- ID renamed from digitalObjectType to algorithmApplicableFor DONE -->
                        <div class="form-group">
                            <label for="algorithmApplicableFor">Is Applicable For</label>
                            <input type="url" id="algorithmApplicableFor" value="https://schema.org/Dataset" required>
                        </div>

                        <!-- ID changed from benchmarkGuid to algorithmIsImplementationOf DONE -->
                        <div class="form-group">
                            <label for="algorithmIsImplementationOf">Registered benchmark GUID</label>
                            <input type="url" id="algorithmIsImplementationOf" value="https://ostrails.github.io/sandbox/mockbenchmark1.ttl" required>
                        </div>
                        
                        <!-- ID new algorithmContactPoint -->
                        <div class="form-group">
                            <label for="algorithmContactPoint">Contact Point</label>
                            <input type="text" id="algorithmContactPoint" value="ann.none@nowhere.uk" required>
                        </div>
                    </div>
                </div>

                <!-- Test Reference Section -->
                <div class="section fade-in">
                    <div class="section-header">
                        <span class="icon">üß™</span>
                        <span>Test References  (see 
          <a href="https://tests.ostrails.eu/tests/" target="_blank" rel="noopener">OSTrails FAIR tests</a>)</span>
                    </div>
                    <div class="section-content">
                        <button type="button" class="btn add-btn" onclick="addItem('test')">+ Add Test Reference</button>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                        <div id="testReferences">
                            <!-- Test references will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Condition Section -->
                <div class="section fade-in">
                    <div class="section-header">
                        <span class="icon">‚öôÔ∏è</span>
                        <span>Evaluation Conditions</span>
                    </div>
                    <div class="section-content">
                        <button type="button" class="btn add-btn" onclick="addItem('condition')">+ Add Condition</button>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                        <div id="conditions">
                            <!-- Conditions will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        üîÑ Reset Form
                        <button class="help-icon" title="Hover for help" tabindex="0" 
                                onmouseover="showHelp('Reset Form - Restore the original Benchmark Algorithm data and lose any changes.')"
                                onfocus="showHelp('Reset Form - Restore the original Benchmark Algorithm data and lose any changes.')">‚ùì</button>
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="validateForm()">
                        ‚úÖ Validate
                        <button class="help-icon" title="Hover for help" tabindex="0"
                                onmouseover="showHelp('Validate - Check if all required fields are filled correctly and show validation results.')"
                                onfocus="showHelp('Validate - Check if all required fields are filled correctly and show validation results.')">‚ùì</button>
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="exportToExcel()">
                        üìä Export to Excel
                        <button class="help-icon" title="Hover for help" tabindex="0"
                                onmouseover="showHelp('Export to Excel - Download the current configuration as an Excel (.xlsx) file.')"
                                onfocus="showHelp('Export to Excel - Download the current configuration as an Excel (.xlsx) file.')">‚ùì</button>
                    </button>

                    <button type="submit" class="btn btn-secondary" onclick="exportToGoogleSheetFormat()">
                        üíæ Export to CSV
                        <button class="help-icon" title="Hover for help" tabindex="0"
                                onmouseover="showHelp('Export Configuration - Download the current configuration as CSV files.')"
                                onfocus="showHelp('Export Configuration - Download the current configuration as CSV files.')">‚ùì</button>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration object to reduce magic strings
        const CONFIG = {
            itemTypes: {
                test: {
                    prefix: 'T',
                    icon: 'üß™',
                    containerClass: 'test-reference-item',
                    containerId: 'testReferences',
                    countProperty: 'testReferenceCount'
                },
                condition: {
                    prefix: 'C',
                    icon: '‚öôÔ∏è',
                    containerClass: 'condition-item',
                    containerId: 'conditions',
                    countProperty: 'conditionCount'
                }
            },
            helpMessages: {
                testId: 'Test ID - Enter a unique identifier for this test reference.',
                testGuid: 'Test GUID - Use a test from https://tests.ostrails.eu/tests/',
                passWeight: 'Pass Weight - Use an integer greater than zero.',
                failWeight: 'Fail Weight - Use an integer less than zero.',
                indeterminateWeight: 'Indeterminate Weight - Use an integer between the Pass and Fail weight range, typically zero.',
                conditionId: 'Condition ID - Enter a unique identifier for this condition.',
                conditionDescription: 'Condition Description - Enter a short description for this evaluation condition.',
                formula: 'Formula - Enter a logical formula using test IDs. Ruby syntax is used for the calculation (e.g. conditional equals is == not =).',
                successMessage: 'Success Message - Enter the message shown when the condition is met.',
                failMessage: 'Fail Message - Enter the message shown when the condition is NOT met.'
            }
        };

        // Sample data for initial test references and conditions
        const initialTestReferences = [
            { id: 'T1', guid: 'https://tests.ostrails.eu/tests/fc_unique_identifier', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T2', guid: 'https://tests.ostrails.eu/tests/fc_searchable', passWeight: 5, failWeight: -1, indeterminateWeight: 0 }
        ];

        const initialConditions = [
            { id: 'C1', description: 'Metadata are assigned globally unique identifiers', formula: 'T1 > 0', successMessage: 'Acceptable: metadata are assigned globally unique identifiers', failMessage: 'Unacceptable: metadata are not assigned globally unique identifiers' },
            { id: 'C2', description: 'Metadata are assigned globally unique identifiers and are registered or indexed in a searchable resource', formula: 'T1 + T2 == 10', successMessage: 'Acceptable: both tests passed', failMessage: 'Unacceptable: one or more tests failed' }
        ];

        let testReferenceCount = 0;
        let conditionCount = 0;

        // Unified function to create help icons
        function createHelpIcon(helpKey) {
            return `<span class="help-icon" style="cursor:help;" title="Hover for help" 
                           onmouseover="showHelp('${CONFIG.helpMessages[helpKey]}')" 
                           onfocus="showHelp('${CONFIG.helpMessages[helpKey]}')">‚ùì</span>`;
        }

        // Unified function to create form groups with help
        function createFormGroup(id, label, type, value, helpKey, attributes = '') {
            const element = type === 'textarea' 
                ? `<textarea id="${id}" ${attributes}>${value}</textarea>`
                : `<input type="${type}" id="${id}" value="${value}" ${attributes}>`;
            
            return `
                <div class="form-group">
                    <label for="${id}">
                        ${label}
                        ${helpKey ? createHelpIcon(helpKey) : ''}
                    </label>
                    ${element}
                </div>
            `;
        }

        // Template generators
        function generateTestReferenceTemplate(data) {
            const config = CONFIG.itemTypes.test;
            const id = data ? data.id : config.prefix + (testReferenceCount + 1);
            
            return `
                <div class="item-header">
                    <h4>${config.icon} ${id}</h4>
                    <button type="button" class="remove-btn" onclick="removeElement(this.closest('.${config.containerClass}'))">Remove</button>
                </div>
                ${createFormGroup('testId', 'Test ID', 'text', id, 'testId', 'name="testId" required')}
                ${createFormGroup('testGuid', 'Enter test GUID (URL)', 'url', data ? data.guid : '', 'testGuid', 'name="testGuid" placeholder="https://tests.ostrails.eu/tests/..." required')}
                <div class="row-three">
                    ${createFormGroup('passWeight', 'Pass Weight', 'number', data ? data.passWeight : 5, 'passWeight', 'name="passWeight" required')}
                    ${createFormGroup('failWeight', 'Fail Weight', 'number', data ? data.failWeight : -1, 'failWeight', 'name="failWeight" required')}
                    ${createFormGroup('indeterminateWeight', 'Indeterminate Weight', 'number', data ? data.indeterminateWeight : 0, 'indeterminateWeight', 'name="indeterminateWeight" required')}
                </div>
            `;
        }

        function generateConditionTemplate(data) {
            const config = CONFIG.itemTypes.condition;
            const id = data ? data.id : config.prefix + (conditionCount + 1);
            
            return `
                <div class="item-header">
                    <h4>${config.icon} ${id}</h4>
                    <button type="button" class="remove-btn" onclick="removeElement(this.closest('.${config.containerClass}'))">Remove</button>
                </div>
                ${createFormGroup('conditionId', 'Condition ID', 'text', id, 'conditionId', 'name="conditionId" required')}
                ${createFormGroup('conditionDescription', 'Description', 'textarea', data ? data.description : '', 'conditionDescription', 'name="conditionDescription" rows="2" required')}
                ${createFormGroup('formula', 'Formula', 'text', data ? data.formula : '', 'formula', 'name="conditionFormula" placeholder="e.g., T1 > 0" required')}
                <div class="row">
                    ${createFormGroup('successMessage', 'Success Message', 'textarea', data ? data.successMessage : '', 'successMessage', 'name="successMessage" rows="3" required')}
                    ${createFormGroup('failMessage', 'Fail Message', 'textarea', data ? data.failMessage : '', 'failMessage', 'name="failMessage" rows="3" required')}
                </div>
            `;
        }

        // Unified add item function
        function addItem(type, data = null) {
            const config = CONFIG.itemTypes[type];
            const container = document.getElementById(config.containerId);
            const div = document.createElement('div');
            div.className = `item ${config.containerClass} fade-in`;
            
            if (type === 'test') {
                div.innerHTML = generateTestReferenceTemplate(data);
                testReferenceCount++;
            } else if (type === 'condition') {
                div.innerHTML = generateConditionTemplate(data);
                conditionCount++;
            }
            
            container.appendChild(div);
            updateStats();
        }

        function initializeForm() {
            initialTestReferences.forEach(test => addItem('test', test));
            initialConditions.forEach(condition => addItem('condition', condition));
            updateStats();
        }

        function removeElement(element) {
            if (confirm('Are you sure you want to remove this item?')) {
                const isTestReference = element.classList.contains('test-reference-item');
                if (isTestReference) {
                    testReferenceCount--;
                } else {
                    conditionCount--;
                }
                element.remove();
                updateStats();
            }
        }

        function updateStats() {
            document.getElementById('testCount').textContent = document.querySelectorAll('.test-reference-item').length;
            document.getElementById('conditionCount').textContent = document.querySelectorAll('.condition-item').length;
        }

        // Unified validation function
        function validateField(field, errors) {
            const label = field.closest('.form-group').querySelector('label').textContent.replace('‚ùì', '').trim();
            
            if (!field.value.trim()) {
                field.style.borderColor = '#ea4335';
                errors.push(`${label} is required`);
                return false;
            }
            
            if (field.type === 'url' && !isValidURL(field.value)) {
                field.style.borderColor = '#ea4335';
                errors.push(`${label} must be a valid URL`);
                return false;
            }
            
            field.style.borderColor = '#34a853';
            return true;
        }

        function validateForm() {
            const form = document.getElementById('algorithmForm');
            let isValid = true;
            let errors = [];

            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!validateField(field, errors)) {
                    isValid = false;
                }
            });

            if (isValid) {
                alert('‚úÖ Form validation passed! All fields are correctly filled.');
                form.querySelectorAll('input, textarea').forEach(field => {
                    field.style.borderColor = '#34a853';
                    setTimeout(() => field.style.borderColor = '#e8eaed', 2000);
                });
            } else {
                alert('‚ùå Form validation failed:\n\n' + errors.join('\n'));
            }

            return isValid;
        }

        function isValidURL(string) {
            try {
        new URL(string);
            return true;
        } catch (error) {
        // Explicitly handle the URL constructor errors
        if (error instanceof TypeError) {
            // This is the expected error when URL is invalid
            return false;
            }
        // Re-throw unexpected errors
        throw error;
            }
        }

        function resetForm() {
            if (confirm('Are you sure you want to reset the form? This will restore the original Benchmark Algorithm data and lose any changes.')) {
                document.body.classList.add('loading');
                
                setTimeout(() => {
                    // Clear containers
                    document.getElementById('testReferences').innerHTML = '';
                    document.getElementById('conditions').innerHTML = '';
                    testReferenceCount = 0;
                    conditionCount = 0;
                    
                    // Reset property values
                    const defaultValues = {
                        algorithmName: 'Generic benchmark algorithm',
                        algorithmVersion: '1.0',
                        algorithmDescription: 'Used in conjunction with FAIR Champion test runner to calculate FAIR scores.',
                        algorithmKeywords: 'FAIR, benchmark, algorithm',
                        algorithmAbbreviation: 'FAIRalgorithm',
                        algorithmRepository: 'https://docs.google.com/spreadsheets/d/16s2klErdtZck2b6i2Zp_PjrgpBBnnrBKaAvTwrnMB4w/edit?gid=0#gid=0',
                        algorithmType: 'https://ontology.ethereal.cz/irao/Benchmark',
                        algorithmLicence: 'https://creativecommons.org/publicdomain/zero/1.0/',
                        algorithmApplicationArea: 'https://www.fairsharing.org/ontology/subject/SRAO_0000401',
                        algorithmApplicableFor: 'https://schema.org/Dataset',
                        algorithmIsImplementationOf: 'https://ostrails.github.io/sandbox/mockbenchmark1.ttl',
                        algorithmContactPoint: 'ann.none@now.uk'
                    };
                    
                    Object.entries(defaultValues).forEach(([id, value]) => {
                        document.getElementById(id).value = value;
                    });
                    
                    initializeForm();
                    document.body.classList.remove('loading');
                }, 500);
            }
        }

        function collectItems(className, fieldNames) {
            const items = [];
            const elements = document.querySelectorAll(`.${className}`);
            
            elements.forEach(item => {
                const inputs = item.querySelectorAll('input, textarea');
                const itemData = {};
                
                fieldNames.forEach((fieldName, index) => {
                    let value = inputs[index].value;
                    if (inputs[index].type === 'number') {
                        value = parseInt(value);
                    }
                    itemData[fieldName] = value;
                });
                
                items.push(itemData);
            });
            
            return items;
        }

        function exportToJSON() {
            const propertyData = {
                title: document.getElementById('algorithmName').value,
                version: document.getElementById('algorithmVersion').value,
                description: document.getElementById('algorithmDescription').value,
                keyword: document.getElementById('algorithmKeywords').value,
                abbreviation: document.getElementById('algorithmAbbreviation').value,
                repository: document.getElementById('algorithmRepository').value,
                type: document.getElementById('algorithmType').value,
                license: document.getElementById('algorithmLicence').value,
                applicationArea: document.getElementById('algorithmApplicationArea').value,
                isApplicableFor: document.getElementById('algorithmApplicableFor').value,
                isImplementationOf: document.getElementById('algorithmIsImplementationOf').value,
                contactPoint: document.getElementById('algorithmContactPoint').value
            };

            const testReferences = collectItems('test-reference-item', ['id', 'guid', 'passWeight', 'failWeight', 'indeterminateWeight']);
            const conditions = collectItems('condition-item', ['id', 'description', 'formula', 'successMessage', 'failMessage']);

            return {
                metadata: {
                    title: "Generic Benchmark Algorithm Configuration",
                    version: "1.0",
                    exportedAt: new Date().toISOString(),
                    totalTests: testReferences.length,
                    totalConditions: conditions.length
                },
                property: propertyData,
                testReferences: testReferences,
                conditions: conditions
            };
        }

        function exportToGoogleSheetFormat() {
            const data = exportToJSON();
            
            let csvContent = "DCAT Property,Value\n";
            Object.entries(data.property).forEach(([key, value]) => {
                csvContent += `"${key}","${value}"\n`;
            });
            
            csvContent += "\nTest Reference,Test GUID,Pass Weight,Fail Weight,Indeterminate Weight\n";
            data.testReferences.forEach(test => {
                csvContent += `"${test.id}","${test.guid}",${test.passWeight},${test.failWeight},${test.indeterminateWeight}\n`;
            });
            
            csvContent += "\nCondition,Description,Formula,Success Message,Fail Message\n";
            data.conditions.forEach(condition => {
                csvContent += `"${condition.id}","${condition.description}","${condition.formula}","${condition.successMessage}","${condition.failMessage}"\n`;
            });

            return csvContent;
        }

    // Main function with reduced complexity
    function downloadExcelFromCSVAdvanced(csvContent, filename, options = {}) {
        const config = getDefaultConfig(options);
        
        try {
            const data = parseCSVContent(csvContent, config.delimiter);
            const workbook = createWorkbook(data, config);
            downloadWorkbook(workbook, filename);
            
            console.log(`Excel file "${filename}.xlsx" downloaded successfully`);
            return true;
            
        } catch (error) {
            handleError(error);
            return false;
        }
    }

    // Configuration helper
    function getDefaultConfig(options) {
        return {
            sheetName: 'Sheet1',
            hasHeaders: true,
            delimiter: ',',
            headerStyle: {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "4472C4" } },
                alignment: { horizontal: "center", vertical: "center" }
            },
            autoFilter: true,
            freezeFirstRow: true,
            ...options
        };
}

    // CSV parsing logic
    function parseCSVContent(csvContent, delimiter) {
        if (typeof Papa !== 'undefined') {
            return parsWithPapaParse(csvContent, delimiter);
        }
        return parseWithFallback(csvContent, delimiter);
    }

    function parsWithPapaParse(csvContent, delimiter) {
        const parsed = Papa.parse(csvContent, {
            delimiter: delimiter,
            skipEmptyLines: false,
            trimHeaders: true
        });
        return parsed.data;
    }

    function parseWithFallback(csvContent, delimiter) {
        return csvContent.split('\n')
            .filter(line => line.trim() !== '')
            .map(line => line.split(delimiter)
                .map(cell => cell.replace(/(^"|"$)/g, '').trim()));
    }

    // Workbook creation and styling
    function createWorkbook(data, config) {
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.aoa_to_sheet(data);
        
        if (shouldApplyStyling(data, config.hasHeaders)) {
            applyWorksheetStyling(worksheet, config);
        }
        
        applyColumnAutoSize(worksheet);
        XLSX.utils.book_append_sheet(workbook, worksheet, config.sheetName);
        
        return workbook;
    }

    function shouldApplyStyling(data, hasHeaders) {
        return hasHeaders && data.length > 0;
    }

    function applyWorksheetStyling(worksheet, config) {
        applyHeaderStyling(worksheet, config.headerStyle);
        
        if (config.autoFilter) {
            worksheet['!autofilter'] = { ref: worksheet['!ref'] };
        }
        
        if (config.freezeFirstRow) {
            worksheet['!freeze'] = { xSplit: 0, ySplit: 1 };
        }
    }

    function applyHeaderStyling(worksheet, headerStyle) {
        const range = XLSX.utils.decode_range(worksheet['!ref']);
        
        for (let col = range.s.c; col <= range.e.c; col++) {
            const headerCell = XLSX.utils.encode_cell({ r: 0, c: col });
            if (worksheet[headerCell]) {
                worksheet[headerCell].s = headerStyle;
            }
        }
    }

    function applyColumnAutoSize(worksheet) {
        const range = XLSX.utils.decode_range(worksheet['!ref']);
        const colWidths = [];
        
        for (let col = range.s.c; col <= range.e.c; col++) {
            const maxWidth = calculateColumnWidth(worksheet, range, col);
            colWidths[col] = { width: Math.min(maxWidth + 2, 50) };
        }
        
        worksheet['!cols'] = colWidths;
    }

    function calculateColumnWidth(worksheet, range, col) {
        let maxWidth = 10;
        
        for (let row = range.s.r; row <= range.e.r; row++) {
            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
            const cell = worksheet[cellAddress];
            
            if (cell?.v) {
                const cellLength = cell.v.toString().length;
                maxWidth = Math.max(maxWidth, cellLength);
            }
        }
        
        return maxWidth;
    }

    // Download functionality
    function downloadWorkbook(workbook, filename) {
        const excelBuffer = XLSX.write(workbook, {
            bookType: 'xlsx',
            type: 'array',
            compression: true
        });
        
        const blob = createExcelBlob(excelBuffer);
        triggerDownload(blob, filename);
    }

    function createExcelBlob(excelBuffer) {
        return new Blob([excelBuffer], {
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        });
    }

    function triggerDownload(blob, filename) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        link.href = url;
        link.download = `${filename}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    // Error handling
    function handleError(error) {
        console.error('Error creating Excel file:', error);
        alert('Error creating Excel file: ' + error.message);
    }

        // Function to export to Excel with enhanced options
        function exportToExcel() {
            const csvData = exportToGoogleSheetFormat(); // Your existing function
            const timestamp = new Date().toISOString().split('T')[0];
           
            // Ensure PapaParse and XLSX are loaded
            if (typeof Papa === 'undefined' || typeof XLSX === 'undefined') {
                alert('Error: Required libraries (PapaParse or XLSX) are not loaded. Please ensure they are included in your HTML.');
                return;
            }

              if (!validateForm()) {
                return;
            }
           
                // Use the enhanced download function
            downloadExcelFromCSVAdvanced(csvData, `generic_benchmark_algorithm_${timestamp}`, {
                sheetName: 'Benchmark Configuration',
                hasHeaders: true,
                autoFilter: true,
                freezeFirstRow: true
            });
            alert('üéâ Configuration exported successfully in Excel file format.\n');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            const submitBtn = e.target.querySelector('[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '‚è≥ Exporting...';
            submitBtn.disabled = true;

            setTimeout(() => {
                // Export to CSV format
                const csvData = exportToGoogleSheetFormat();
                const timestamp = new Date().toISOString().split('T')[0];
                
                downloadFile(csvData, `generic_benchmark_algorithm_${timestamp}.csv`, 'text/csv');

                submitBtn.textContent = originalText;
                submitBtn.disabled = false;

                alert('üéâ Configuration exported successfully in CSV file format.\n');
            }, 1000);
        }

        function addKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            document.getElementById('algorithmForm').dispatchEvent(new Event('submit'));
                            break;
                        case 'r':
                            e.preventDefault();
                            resetForm();
                            break;
                    }
                }
            });
        }

        function animateSections() {
            const sections = document.querySelectorAll('.section');
            sections.forEach((section, index) => {
                setTimeout(() => {
                    section.style.opacity = '0';
                    section.style.transform = 'translateY(20px)';
                    section.style.transition = 'all 0.5s ease';
                    setTimeout(() => {
                        section.style.opacity = '1';
                        section.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 200);
            });
        }

        function setupAutoBackup() {
            setInterval(function() {
                try {
                    const data = exportToGoogleSheetFormat();
                    const backup = {
                        data: data,
                        timestamp: new Date().toISOString()
                    };
                    console.log('Auto-backup created at:', backup.timestamp);
                } catch (error) {
                    console.warn('Auto-backup failed:', error);
                }
            }, 30000);
        }

        function showHelp(message) {
            alert('üí° Help: ' + message);
        }

        // Initialize everything when page loads
        window.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            animateSections();
            addKeyboardShortcuts();
            setupAutoBackup();
            
            // Attach event listeners
            document.getElementById('algorithmForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
</body>
</html>
