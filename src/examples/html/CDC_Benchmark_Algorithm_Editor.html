<!DOCTYPE html>
<html lang="en">
<!--
    File: CDC_Benchmark_Algorithm_Editor.html
    Purpose: Form for editing and managing generic benchmark algorithms. 
    The form allows users to define algorithm properties, test references, and evaluation conditions.
    Use can export the configuration as JSON and CSV files, then import the CVS into a Google Sheet for use 
    with the FAIR Champion Benchmark Quality Assessment tool.
    The Google Sheet must be editable by anonymous users.

    REFACTORED: Reduced code duplication by extracting common functions and patterns

    TODO: Review the use of the 'xxxCount--' code in the removeElement function.
    This code decrements the count of test references and conditions when an item is removed.
    It works as expected if the highest ID is removed, but may cause issues with duplicate IDs
    if a lower ID is removed first.
    Consider removing this code to simplify the logic and avoid potential issues with duplicate IDs.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDC Benchmark Algorithm Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #202124;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #c5f442 0%, #47b73a 100%);
            color: white;
            padding: 32px 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.03) 2px,
                rgba(255,255,255,0.03) 4px
            );
            animation: shimmer 20s linear infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header h1 {
            font-size: 28px;
            font-weight: 300;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .form-content {
            padding: 32px 24px;
        }

        .section {
            margin-bottom: 40px;
            border: 1px solid #e8eaed;
            border-radius: 12px;
            overflow: hidden;
            transition: box-shadow 0.3s ease;
        }

        .section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f0fe 100%);
            padding: 20px 24px;
            border-bottom: 1px solid #e8eaed;
            font-weight: 500;
            font-size: 18px;
            color: #1f1f1f;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-header .icon {
            font-size: 24px;
        }

        .section-content {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #202124;
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="number"],
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e8eaed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #fafafa;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4285f4;
            background: white;
            box-shadow: 0 0 0 4px rgba(66, 133, 244, 0.1);
            transform: translateY(-1px);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .item {
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            border: 2px solid #e8eaed;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .test-reference-item:hover {
            border-color: #4285f4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.1);
        }

        .condition-item:hover {
            border-color: #34a853;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .item-header h4 {
            color: #1f1f1f;
            font-size: 16px;
            font-weight: 500;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .row-three {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .btn {
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
            color: white;
            padding: 14px 28px;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(26, 115, 232, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #5f6368;
            border: 2px solid #e8eaed;
            padding: 12px 24px;
            margin-right: 12px;
        }

        .btn-secondary:hover {
            border-color: #4285f4;
            color: #4285f4;
            transform: translateY(-1px);
        }

        .add-btn {
            background: linear-gradient(135deg, #34a853 0%, #2d7d32 100%);
            color: white;
            padding: 10px 20px;
            font-size: 13px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(52, 168, 83, 0.3);
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.4);
        }

        .remove-btn {
            background: linear-gradient(135deg, #ea4335 0%, #d33b2c 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
        }

        .remove-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(234, 67, 53, 0.4);
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 40px;
            padding-top: 32px;
            border-top: 2px solid #f1f3f4;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #90caf9;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 600;
            color: #1565c0;
        }

        .stat-label {
            font-size: 12px;
            color: #1976d2;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar {
            height: 4px;
            background: #e8eaed;
            border-radius: 2px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4285f4, #34a853);
            transition: width 0.5s ease;
        }

        .help-icon {
            cursor: help;
            background: none;
            border: none;
            padding: 0;
            font: inherit;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .row, .row-three {
                grid-template-columns: 1fr;
            }
            
            .form-content {
                padding: 20px 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Generic Benchmark Algorithm Editor</h1>
            <p>Use this form to generate a CSV file that can be imported into a Benchmark Configuration Google Sheet for use with the 
      <a href="https://tools.ostrails.eu/champion/assess/algorithm/new" target="_blank" rel="noopener">FAIR Champion Benchmark Quality Assessment tool</a>
    </p>
        </div>
        <div class="form-content">
            <!-- Statistics Section -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="testCount">2</div>
                    <div class="stat-label">Test References</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="conditionCount">2</div>
                    <div class="stat-label">Conditions</div>
                </div>
            </div>

            <form id="algorithmForm">
                <!-- Property Section -->
                <div class="section fade-in">
                    <div class="section-header">
                        <span class="icon">üìã</span>
                        <span>Algorithm Properties</span>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="algorithmName">Algorithm Name</label>
                            <input type="text" id="algorithmName" value="Generic benchmark algorithm" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="benchmarkGuid">Benchmark GUID</label>
                            <input type="url" id="benchmarkGuid" value="https://ostrails.github.io/sandbox/mockbenchmark1.ttl" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="relevantCommunity">Relevant Community (URL)</label>
                            <input type="url" id="relevantCommunity" value="https://www.fairsharing.org/ontology/subject/SRAO_0000002" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="digitalObjectType">Applicable Digital Object Type (URL)</label>
                            <input type="url" id="digitalObjectType" value="https://schema.org/Dataset" required>
                        </div>
                    </div>
                </div>

                <!-- Test Reference Section -->
                <div class="section fade-in">
                    <div class="section-header">
                        <span class="icon">üß™</span>
                        <span>Test References  (see 
          <a href="https://tests.ostrails.eu/tests/" target="_blank" rel="noopener">OSTrails FAIR tests</a>)</span>
                    </div>
                    <div class="section-content">
                        <button type="button" class="btn add-btn" onclick="addItem('test')">+ Add Test Reference</button>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                        <div id="testReferences">
                            <!-- Test references will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Condition Section -->
                <div class="section fade-in">
                    <div class="section-header">
                        <span class="icon">‚öôÔ∏è</span>
                        <span>Evaluation Conditions</span>
                    </div>
                    <div class="section-content">
                        <button type="button" class="btn add-btn" onclick="addItem('condition')">+ Add Condition</button>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                        <div id="conditions">
                            <!-- Conditions will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        üîÑ Reset Form
                        <button class="help-icon" title="Hover for help" tabindex="0" 
                                onmouseover="showHelp('Reset Form - Restore the original Benchmark Algorithm data and lose any changes.')"
                                onfocus="showHelp('Reset Form - Restore the original Benchmark Algorithm data and lose any changes.')">‚ùì</button>
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="validateForm()">
                        ‚úÖ Validate
                        <button class="help-icon" title="Hover for help" tabindex="0"
                                onmouseover="showHelp('Validate - Check if all required fields are filled correctly and show validation results.')"
                                onfocus="showHelp('Validate - Check if all required fields are filled correctly and show validation results.')">‚ùì</button>
                    </button>
                    
                    <button type="submit" class="btn btn-secondary">
                        üíæ Export Configuration
                        <button class="help-icon" title="Hover for help" tabindex="0"
                                onmouseover="showHelp('Export Configuration - Download the current configuration as JSON and CSV files.')"
                                onfocus="showHelp('Export Configuration - Download the current configuration as JSON and CSV files.')">‚ùì</button>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration object to reduce magic strings
        const CONFIG = {
            itemTypes: {
                test: {
                    prefix: 'T',
                    icon: 'üß™',
                    containerClass: 'test-reference-item',
                    containerId: 'testReferences',
                    countProperty: 'testReferenceCount'
                },
                condition: {
                    prefix: 'C',
                    icon: '‚öôÔ∏è',
                    containerClass: 'condition-item',
                    containerId: 'conditions',
                    countProperty: 'conditionCount'
                }
            },
            helpMessages: {
                testId: 'Test ID - Enter a unique identifier for this test reference.',
                testGuid: 'Test GUID - Use a test from https://tests.ostrails.eu/tests/',
                passWeight: 'Pass Weight - Use an integer greater than zero.',
                failWeight: 'Fail Weight - Use an integer less than zero.',
                indeterminateWeight: 'Indeterminate Weight - Use an integer between the Pass and Fail weight range, typically zero.',
                conditionId: 'Condition ID - Enter a unique identifier for this condition.',
                conditionDescription: 'Condition Description - Enter a short description for this evaluation condition.',
                formula: 'Formula - Enter a logical formula using test IDs. Ruby syntax is used for the calculation (e.g. conditional equals is == not =).',
                successMessage: 'Success Message - Enter the message shown when the condition is met.',
                failMessage: 'Fail Message - Enter the message shown when the condition is NOT met.'
            }
        };

        // Sample data for initial test references and conditions
        const initialTestReferences = [
            { id: 'T1', guid: 'https://tests.ostrails.eu/tests/fc_unique_identifier', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T2', guid: 'https://tests.ostrails.eu/tests/fc_unique_identifier', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T3', guid: 'https://tests.ostrails.eu/tests/fc_structured_metadata', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T4', guid: 'https://tests.ostrails.eu/tests/fc_unique_identifier', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T5', guid: 'https://tests.ostrails.eu/tests/fc_searchable', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T6', guid: 'https://tests.ostrails.eu/tests/fc_metadata_protocol', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T7', guid: 'https://tests.ostrails.eu/tests/fc_data_protocol', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T8', guid: 'https://tests.ostrails.eu/tests/fc_data_authorization', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T9', guid: 'https://tests.ostrails.eu/tests/fc_metadata_identifier_persistence', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T10', guid: 'https://tests.ostrails.eu/tests/fc_data_kr_language_weak', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T11', guid: 'https://tests.ostrails.eu/tests/fc_metadata_uses_fair_vocabularies', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T12', guid: 'https://tests.ostrails.eu/tests/fc_metadata_outward_links', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T13', guid: 'https://tests.ostrails.eu/tests/fc_unique_identifier', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T14', guid: 'https://tests.ostrails.eu/tests/fc_metadata_includes_license_weak', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T15', guid: 'https://tests.ostrails.eu/tests/fc_unique_identifier', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T16', guid: 'https://tests.ostrails.eu/tests/fc_grounded_metadata', passWeight: 5, failWeight: -1, indeterminateWeight: 0 },
            { id: 'T17', guid: 'https://tests.ostrails.eu/tests/fc_unique_identifier', passWeight: 5, failWeight: -1, indeterminateWeight: 0 }
            ];

        const initialConditions = [
            { id: 'C1', description: 'Metadata are assigned globally unique identifiers', formula: 'T1 > 0', successMessage: 'Acceptable: metadata are assigned globally unique identifiers', failMessage: 'Unacceptable: metadata are not assigned globally unique identifiers' },
            { id: 'C2', description: 'Metadata are assigned persistent identifiers', formula: 'T2 > 0', successMessage: 'Acceptable: metadata are assigned persistent identifiers', failMessage: 'Unacceptable: metadata are not assigned persistent identifiers' },
            { id: 'C3', description: 'Data are described with rich metadata', formula: 'T3 > 0', successMessage: 'Acceptable: data are described with rich metadata', failMessage: 'Unacceptable: data are not described with rich metadata' },
            { id: 'C4', description: 'Metadata clearly and explicitly include the identifier of the data they describe', formula: 'T4 > 0', successMessage: 'Acceptable: data identifier found', failMessage: 'Unacceptable: data identifier not found' },
            { id: 'C5', description: 'Metadata are registered or indexed in a searchable resource', formula: 'T5 > 0', successMessage: 'Acceptable: metadata are searchable', failMessage: 'Unacceptable: metadata are not searchable' },
            { id: 'C6', description: 'Metadata are retrievable by their identifier using a standardized communications protocol', formula: 'T6 > 0', successMessage: 'Acceptable: metadata are retreivable via a standardized communications protocol', failMessage: 'Unacceptable: metadata are not retreivable via a standardized communications protocol' },
            { id: 'C7', description: 'The protocol is open, free, and universally implementable', formula: 'T7 > 0', successMessage: 'Acceptable: the protocol is open, free, and universally implementable', failMessage: 'Unacceptable: the protocol is not open, free, and universally implementable' },
            { id: 'C8', description: 'The protocol allows for an authentication and authorization procedure, where necessary', formula: 'T8 > 0', successMessage: 'Acceptable: the protocol allows for an authentication and authorization procedure, where necessary', failMessage: 'Unacceptable: the protocol does not allow for an authentication and authorization procedure, where necessary' },
            { id: 'C9', description: 'Metadata are accessible, even when the data are no longer available', formula: 'T9 > 0', successMessage: 'Acceptable: metadata are accessible, even when the data are no longer available', failMessage: 'Unacceptable: metadata are not accessible when the data are no longer available' },
            { id: 'C10', description: 'Metadata use a formal, accessible, shared, and broadly applicable language for knowledge representation', formula: 'T10 > 0', successMessage: 'Acceptable: metadata use a formal, accessible, shared, and broadly applicable language for knowledge representation', failMessage: 'Unacceptable: metadata does not use a formal, accessible, shared, and broadly applicable language for knowledge representation' },
            { id: 'C11', description: 'Metadata use vocabularies that follow FAIR principles', formula: 'T11 > 0', successMessage: 'Acceptable: metadata use vocabularies that follow FAIR principles', failMessage: 'Unacceptable: metadata use vocabularies that do not follow FAIR principles' },
            { id: 'C12', description: 'Metadata include qualified references to other (meta)data', formula: 'T12 > 0', successMessage: 'Acceptable: metadata include qualified references to other metadata', failMessage: 'Unacceptable: metadata do not include qualified references to other metadata' },
            { id: 'C13', description: 'Metadata are richly described with a plurality of accurate and relevant attributes', formula: 'T13 > 0', successMessage: 'Acceptable: data richly described with a plurality of accurate and relevant attributes', failMessage: 'Unacceptable: data not richly described with a plurality of accurate and relevant attributes' },
            { id: 'C14', description: 'Metadata are released with a clear and accessible data usage license', formula: 'T14 > 0', successMessage: 'Acceptable: metadata released with a clear and accessible data usage license', failMessage: 'Unacceptable: metadata not released with a clear and accessible data usage license' },
            { id: 'C15', description: 'Metadata are associated with detailed provenance', formula: 'T15 > 0', successMessage: 'Acceptable: data associated with detailed provenance', failMessage: 'Unacceptable: data not associated with detailed provenance' },
            { id: 'C16', description: 'Metadata meet domain-relevant community standards', formula: 'T16 > 0', successMessage: 'Acceptable: metadata meet domain-relevant community standards', failMessage: 'Unacceptable: metadata do not meet domain-relevant community standards' },
            { id: 'C17', description: 'GUID matches a GUID scheme recognised as being globally unique', formula: 'T17 > 0', successMessage: 'Acceptable: GUID matches a scheme recognised as being globally unique', failMessage: 'Unacceptable: GUID does not match a scheme recognised as being globally unique' },
            { id: 'C18', description: 'Majority of FINDABLE tests passed', formula: 'T1 + T2 +T3 +T4 +T5 > 12', successMessage: 'Acceptable: Data mostly FINDABLE', failMessage: 'Unacceptable: Data mostly not FINDABLE' },
            { id: 'C19', description: 'Majority of ACCESSIBLE tests passed', formula: 'T6 + T7 +T8 + T9 > 13', successMessage: 'Acceptable: Data mostly ACCESSIBLE', failMessage: 'Unacceptable: Data mostly not ACCESSIBLE' },
            { id: 'C20', description: 'Majority of INTEROPERABLE tests passed', formula: 'T10 + T11 + T12 > 13', successMessage: 'Acceptable: Data mostly INTEROPERABLE', failMessage: 'Unacceptable: Data mostly not INTEROPERABLE' },
            { id: 'C21', description: 'Majority of REUSABLE tests passed', formula: 'T13 + T14 + T14 + T16 + T17 > 12', successMessage: 'Acceptable: Data mostly REUSABLE', failMessage: 'Unacceptable: Data mostly not REUSABLE' }     
             ];

        let testReferenceCount = 0;
        let conditionCount = 0;

        // Unified function to create help icons
        function createHelpIcon(helpKey) {
            return `<span class="help-icon" style="cursor:help;" title="Hover for help" 
                           onmouseover="showHelp('${CONFIG.helpMessages[helpKey]}')" 
                           onfocus="showHelp('${CONFIG.helpMessages[helpKey]}')">‚ùì</span>`;
        }

        // Unified function to create form groups with help
        function createFormGroup(id, label, type, value, helpKey, attributes = '') {
            const inputType = type === 'textarea' ? 'textarea' : `input type="${type}"`;
            const element = type === 'textarea' 
                ? `<textarea id="${id}" ${attributes}>${value}</textarea>`
                : `<input type="${type}" id="${id}" value="${value}" ${attributes}>`;
            
            return `
                <div class="form-group">
                    <label for="${id}">
                        ${label}
                        ${helpKey ? createHelpIcon(helpKey) : ''}
                    </label>
                    ${element}
                </div>
            `;
        }

        // Template generators
        function generateTestReferenceTemplate(data) {
            const config = CONFIG.itemTypes.test;
            const id = data ? data.id : config.prefix + (testReferenceCount + 1);
            
            return `
                <div class="item-header">
                    <h4>${config.icon} ${id}</h4>
                    <button type="button" class="remove-btn" onclick="removeElement(this.closest('.${config.containerClass}'))">Remove</button>
                </div>
                ${createFormGroup('testId', 'Test ID', 'text', id, 'testId', 'name="testId" required')}
                ${createFormGroup('testGuid', 'Enter test GUID (URL)', 'url', data ? data.guid : '', 'testGuid', 'name="testGuid" placeholder="https://tests.ostrails.eu/tests/..." required')}
                <div class="row-three">
                    ${createFormGroup('passWeight', 'Pass Weight', 'number', data ? data.passWeight : 5, 'passWeight', 'name="passWeight" required')}
                    ${createFormGroup('failWeight', 'Fail Weight', 'number', data ? data.failWeight : -1, 'failWeight', 'name="failWeight" required')}
                    ${createFormGroup('indeterminateWeight', 'Indeterminate Weight', 'number', data ? data.indeterminateWeight : 0, 'indeterminateWeight', 'name="indeterminateWeight" required')}
                </div>
            `;
        }

        function generateConditionTemplate(data) {
            const config = CONFIG.itemTypes.condition;
            const id = data ? data.id : config.prefix + (conditionCount + 1);
            
            return `
                <div class="item-header">
                    <h4>${config.icon} ${id}</h4>
                    <button type="button" class="remove-btn" onclick="removeElement(this.closest('.${config.containerClass}'))">Remove</button>
                </div>
                ${createFormGroup('conditionId', 'Condition ID', 'text', id, 'conditionId', 'name="conditionId" required')}
                ${createFormGroup('conditionDescription', 'Description', 'textarea', data ? data.description : '', 'conditionDescription', 'name="conditionDescription" rows="2" required')}
                ${createFormGroup('formula', 'Formula', 'text', data ? data.formula : '', 'formula', 'name="conditionFormula" placeholder="e.g., T1 > 0" required')}
                <div class="row">
                    ${createFormGroup('successMessage', 'Success Message', 'textarea', data ? data.successMessage : '', 'successMessage', 'name="successMessage" rows="3" required')}
                    ${createFormGroup('failMessage', 'Fail Message', 'textarea', data ? data.failMessage : '', 'failMessage', 'name="failMessage" rows="3" required')}
                </div>
            `;
        }

        // Unified add item function
        function addItem(type, data = null) {
            const config = CONFIG.itemTypes[type];
            const container = document.getElementById(config.containerId);
            const div = document.createElement('div');
            div.className = `item ${config.containerClass} fade-in`;
            
            if (type === 'test') {
                div.innerHTML = generateTestReferenceTemplate(data);
                testReferenceCount++;
            } else if (type === 'condition') {
                div.innerHTML = generateConditionTemplate(data);
                conditionCount++;
            }
            
            container.appendChild(div);
            updateStats();
        }

        function initializeForm() {
            initialTestReferences.forEach(test => addItem('test', test));
            initialConditions.forEach(condition => addItem('condition', condition));
            updateStats();
        }

        function removeElement(element) {
            if (confirm('Are you sure you want to remove this item?')) {
                const isTestReference = element.classList.contains('test-reference-item');
                if (isTestReference) {
                    testReferenceCount--;
                } else {
                    conditionCount--;
                }
                element.remove();
                updateStats();
            }
        }

        function updateStats() {
            document.getElementById('testCount').textContent = document.querySelectorAll('.test-reference-item').length;
            document.getElementById('conditionCount').textContent = document.querySelectorAll('.condition-item').length;
        }

        // Unified validation function
        function validateField(field, errors) {
            const label = field.closest('.form-group').querySelector('label').textContent.replace('‚ùì', '').trim();
            
            if (!field.value.trim()) {
                field.style.borderColor = '#ea4335';
                errors.push(`${label} is required`);
                return false;
            }
            
            if (field.type === 'url' && !isValidURL(field.value)) {
                field.style.borderColor = '#ea4335';
                errors.push(`${label} must be a valid URL`);
                return false;
            }
            
            field.style.borderColor = '#34a853';
            return true;
        }

        function validateForm() {
            const form = document.getElementById('algorithmForm');
            let isValid = true;
            let errors = [];

            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!validateField(field, errors)) {
                    isValid = false;
                }
            });

            if (isValid) {
                alert('‚úÖ Form validation passed! All fields are correctly filled.');
                form.querySelectorAll('input, textarea').forEach(field => {
                    field.style.borderColor = '#34a853';
                    setTimeout(() => field.style.borderColor = '#e8eaed', 2000);
                });
            } else {
                alert('‚ùå Form validation failed:\n\n' + errors.join('\n'));
            }

            return isValid;
        }

        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (error) {
                return false;
            }
        }

        function resetForm() {
            if (confirm('Are you sure you want to reset the form? This will restore the original Benchmark Algorithm data and lose any changes.')) {
                document.body.classList.add('loading');
                
                setTimeout(() => {
                    // Clear containers
                    document.getElementById('testReferences').innerHTML = '';
                    document.getElementById('conditions').innerHTML = '';
                    testReferenceCount = 0;
                    conditionCount = 0;
                    
                    // Reset property values
                    const defaultValues = {
                        algorithmName: 'Generic benchmark algorithm',
                        benchmarkGuid: 'https://ostrails.github.io/sandbox/mockbenchmark1.ttl',
                        relevantCommunity: 'http://www.fairsharing.org/ontology/subject/SRAO_0000002',
                        digitalObjectType: 'https://schema.org/Dataset'
                    };
                    
                    Object.entries(defaultValues).forEach(([id, value]) => {
                        document.getElementById(id).value = value;
                    });
                    
                    initializeForm();
                    document.body.classList.remove('loading');
                }, 500);
            }
        }

        function collectItems(className, fieldNames) {
            const items = [];
            const elements = document.querySelectorAll(`.${className}`);
            
            elements.forEach(item => {
                const inputs = item.querySelectorAll('input, textarea');
                const itemData = {};
                
                fieldNames.forEach((fieldName, index) => {
                    let value = inputs[index].value;
                    if (inputs[index].type === 'number') {
                        value = parseInt(value);
                    }
                    itemData[fieldName] = value;
                });
                
                items.push(itemData);
            });
            
            return items;
        }

        function exportToJSON() {
            const propertyData = {
                algorithmName: document.getElementById('algorithmName').value,
                benchmarkGuid: document.getElementById('benchmarkGuid').value,
                relevantCommunity: document.getElementById('relevantCommunity').value,
                digitalObjectType: document.getElementById('digitalObjectType').value
            };

            const testReferences = collectItems('test-reference-item', ['id', 'guid', 'passWeight', 'failWeight', 'indeterminateWeight']);
            const conditions = collectItems('condition-item', ['id', 'description', 'formula', 'successMessage', 'failMessage']);

            return {
                metadata: {
                    title: "Generic Benchmark Algorithm Configuration",
                    version: "1.0",
                    exportedAt: new Date().toISOString(),
                    totalTests: testReferences.length,
                    totalConditions: conditions.length
                },
                property: propertyData,
                testReferences: testReferences,
                conditions: conditions
            };
        }

        function exportToGoogleSheetFormat() {
            const data = exportToJSON();
            
            let csvContent = "Property,Value\n";
            Object.entries(data.property).forEach(([key, value]) => {
                const formattedKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                csvContent += `"${formattedKey}","${value}"\n`;
            });
            
            csvContent += "\nTest Reference,Test GUID,Pass Weight,Fail Weight,Indeterminate Weight\n";
            data.testReferences.forEach(test => {
                csvContent += `"${test.id}","${test.guid}",${test.passWeight},${test.failWeight},${test.indeterminateWeight}\n`;
            });
            
            csvContent += "\nCondition,Description,Formula,Success Message,Fail Message\n";
            data.conditions.forEach(condition => {
                csvContent += `"${condition.id}","${condition.description}","${condition.formula}","${condition.successMessage}","${condition.failMessage}"\n`;
            });

            return csvContent;
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            const submitBtn = e.target.querySelector('[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '‚è≥ Exporting...';
            submitBtn.disabled = true;

            setTimeout(() => {
                const jsonData = exportToJSON();
                const csvData = exportToGoogleSheetFormat();
                const timestamp = new Date().toISOString().split('T')[0];
                
                downloadFile(JSON.stringify(jsonData, null, 2), `generic_benchmark_algorithm_${timestamp}.json`, 'application/json');
                downloadFile(csvData, `generic_benchmark_algorithm_${timestamp}.csv`, 'text/csv');

                submitBtn.textContent = originalText;
                submitBtn.disabled = false;

                alert('üéâ Configuration exported successfully!\n\nüìÑ JSON file: Complete structured data\nüìä CSV file: Ready to import into Google Sheets\n\nBoth files have been downloaded to your computer.');
            }, 1000);
        }

        function addKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            document.getElementById('algorithmForm').dispatchEvent(new Event('submit'));
                            break;
                        case 'r':
                            e.preventDefault();
                            resetForm();
                            break;
                    }
                }
            });
        }

        function animateSections() {
            const sections = document.querySelectorAll('.section');
            sections.forEach((section, index) => {
                setTimeout(() => {
                    section.style.opacity = '0';
                    section.style.transform = 'translateY(20px)';
                    section.style.transition = 'all 0.5s ease';
                    setTimeout(() => {
                        section.style.opacity = '1';
                        section.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 200);
            });
        }

        function setupAutoBackup() {
            setInterval(function() {
                try {
                    const data = exportToJSON();
                    const backup = {
                        data: data,
                        timestamp: new Date().toISOString()
                    };
                    console.log('Auto-backup created at:', backup.timestamp);
                } catch (error) {
                    console.warn('Auto-backup failed:', error);
                }
            }, 30000);
        }

        function showHelp(message) {
            alert('üí° Help: ' + message);
        }

        // Initialize everything when page loads
        window.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            animateSections();
            addKeyboardShortcuts();
            setupAutoBackup();
            
            // Attach event listeners
            document.getElementById('algorithmForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
</body>
</html>
